@model (FanficModel, List<ChapterModel>, List<string>, bool)

<div class="controller">

    <div class="d-flex flex-wrap justify-content-between align-items-center my-2"> @*Заголовок*@
        <h3>@Model.Item1.Name.</h3>

        <p class="mb-0">Average rating: @Math.Round(Model.Item1.MarkAverage, 2)</p>

        @if (User.Identity.IsAuthenticated)
        {
            <div class="d-flex justify-content-end align-items-center mr-1" onmouseover="onMouseOver(event)" onmouseout="onMouseOut()">
                <img class="mr-2 markimg" height="40" src="/images/emptystar.png" data-mark="1" />
                <img class="mr-2 markimg" height="40" src="/images/emptystar.png" data-mark="2" />
                <img class="mr-2 markimg" height="40" src="/images/emptystar.png" data-mark="3" />
                <img class="mr-2 markimg" height="40" src="/images/emptystar.png" data-mark="4" />
                <img class="mr-2 markimg" height="40" src="/images/emptystar.png" data-mark="5" />
            </div>

            <script src="/lib/signalr/dist/browser/signalr.min.js"></script>
            <script>
                let mark = 0;
                let images = document.getElementsByClassName("markimg");

                function setMark(value) {
                    for (let i = 0; i < value; i++) {
                        images[i].src = "/images/fullstar.png"
                    }
                    for (let i = value; i < 5; i++) {
                        images[i].src = "/images/emptystar.png"
                    }
                }

                function onMouseOver(event) {
                    if (event.target.tagName.toLowerCase() == "img") {
                        let tempMark = +event.target.dataset.mark;
                        setMark(tempMark);
                    }
                }

                function onMouseOut() {
                    setMark(mark);
                }

                function onImgClick(event) {
                    let tempMark = +event.target.dataset.mark;
                    console.log("aaaaaaaaaaaaaaaaaaaaaaaaaaaa");
                    hubConnection.invoke("ChangeMark", tempMark);
                }


                const hubConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/Mark?fanficId=" + "@Model.Item1.Id")
                    .build();

                hubConnection.on('SetMark', function (value) {
                    mark = value;
                    setMark(mark);
                });

                for (let img of images) {
                    console.log("aaaaaaa");
                    img.onclick = onImgClick;
                }

                hubConnection.start();
            </script>
        }
    </div>

    @if (User.Identity.IsAuthenticated)
    {
        <div class="d-flex flex-wrap justify-content-end align-items-center my-2"> @*Закладки*@
            @if(Model.Item4)
            {
                <p>Added to bookmarks</p>
            }
            else
            { 
                <a href="/Fanfic/Bookmark/@Model.Item1.Id">Add to bookmarks</a>
            }
        </div>
    }
    

    <div class="d-flex flex-wrap justify-content-start align-items-center my-2"> @*Тэги*@
        @foreach (string tag in Model.Item3)
        {
            <div class="rounded bg-warning px-2 mx-1">
                @tag
            </div>
        }
    </div>

    <div class="p-2"> @*Описание*@
        @Model.Item1.Description
    </div>

    <div class="p-2 pl-4"> @*Главы*@
        @foreach (var chapter in Model.Item2)
        {
            <a href="/Chapter/Index/@chapter.Id">@chapter.Name</a>
        }
    </div>
</div>